name: Roll Back Cloudflare Worker on Failed Health Check

on:
  push:
    branches: [features/CD]

# minimal repo permissions; adjust if you need to write artifacts etc.
permissions:
  contents: read

env:
  # set defaults here; override via job env or repository secrets if needed
  WORKER_NAME: todo-worker
  RETRIES: 6
  RETRY_DELAY_SEC: 5
  HEALTH_URL: "https://todo-worker.vg-firmly.workers.dev/"

jobs:
  run-tests:
    name: Run tests
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install dependencies
        run: |
          npm ci

      # - name: Run tests
      #   run: |
      #     npm test
      # this job will fail the workflow if tests fail

  deploy:
    name: Deploy with wrangler
    runs-on: ubuntu-latest
    needs: run-tests
    environment: production
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_PROD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install wrangler
        run: |
          npm ci
          npm i -D wrangler@latest

      - name: Deploy
        run: |
          set -e
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "CF secrets not present — aborting deploy."
            exit 1
          fi

          echo "Deploying ${{ env.WORKER_NAME }}..."
          npx wrangler deploy --name "${{ env.WORKER_NAME }}"

  health-check:
    name: Health check (non-failing; reports pass/fail)
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      health_ok: ${{ steps.set_out.outputs.health_ok }}
    environment: production
    steps:
      - name: Simple health probe with retries
        id: probe
        run: |
          set -e
          # If no health URL configured, mark as failed (you can change this policy)
          if [ -z "${{ env.HEALTH_URL }}" ]; then
            echo "No HEALTH_URL provided; marking health as failed."
            echo "health_ok=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          ok=false
          for i in $(seq 1 ${{ env.RETRIES }}); do
            echo "Health attempt $i..."
            # store body and http code
            http_code=$(curl -s -w "%{http_code}" -o /tmp/health_resp.txt "${{ env.HEALTH_URL }}" || true)
            body=$(cat /tmp/health_resp.txt || true)
            echo "status=$http_code"
            echo "body=$body"
            # Change condition to match your expected shape. Here we accept 200 and body contains "ok"
            if [ "$http_code" = "200" ] && echo "$body" | grep -qi "ok"; then
              ok=true
              break
            fi
            sleep ${{ env.RETRY_DELAY_SEC }}
          done

          if [ "$ok" = "true" ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Set job output
        id: set_out
        run: |
          if [ "${{ steps.probe.outputs.health_ok }}" = "true" ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

  rollback:
    name: Rollback to previous version (runs only when health-check reports failure)
    runs-on: ubuntu-latest
    needs: [health-check, deploy]
    if: needs.health-check.outputs.health_ok == 'false'
    environment: production
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_PROD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install wrangler
        run: |
          npm ci
          npm i -D wrangler@latest

      - name: Rollback using wrangler
        run: |
          set -e
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "CF secrets not present — aborting rollback."
            exit 1
          fi

          echo "Rolling back ${{ env.WORKER_NAME }} to previous version..."
          # wrangler rollback automatically finds and rolls back to the previous version
          npx wrangler rollback --name "${{ env.WORKER_NAME }}"
