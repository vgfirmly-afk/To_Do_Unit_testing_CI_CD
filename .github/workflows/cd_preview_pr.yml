name: "PR — Cloudflare Workers preview"

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  # pattern for preview worker; short sha appended for uniqueness
  PREVIEW_PREFIX: pr

jobs:
  preview:
    # run for non-closed PR events
    if: ${{ github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      # - name: Build
      #   run: npm run build

      - name: Create short SHA
        run: echo "SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_ENV

      - name: Set preview name (PR number + short sha)
        run: echo "PREVIEW_NAME=${{ env.PREVIEW_PREFIX }}-${{ github.event.number }}-${SHORT_SHA}" >> $GITHUB_ENV

      - name: Deploy preview with Wrangler (deploy is the recommended command)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN_PROD }}
          # deploy (not deprecated publish). we set the worker name to the preview name.
          command: deploy --name ${{ env.PREVIEW_NAME }}

      - name: Comment preview URL on PR (create or update)
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: |
            ✅ Preview deployed for this PR

            **Preview URL:** `https://${{ env.PREVIEW_NAME }}.workers.dev`

            _Preview name:_ `{{ env.PREVIEW_NAME }}`

  cleanup:
    # only run when PR is closed
    if: ${{ github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Determine preview name
        # recreate the exact preview name used above
        run: |
          SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-7)
          echo "PREVIEW_NAME=${{ env.PREVIEW_PREFIX }}-${{ github.event.number }}-${SHORT_SHA}" >> $GITHUB_ENV

      - name: Attempt to delete preview worker (Cloudflare API)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "$ACCOUNT_ID" ]; then
            echo "Missing CLOUDFLARE_ACCOUNT_ID secret — skipping delete."
            exit 0
          fi

          # delete the worker script for the preview name
          echo "Deleting preview worker: $PREVIEW_NAME"
          curl --silent --show-error --fail -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/workers/scripts/$PREVIEW_NAME" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            || echo "Delete call failed or script not found (that's OK)."

            
