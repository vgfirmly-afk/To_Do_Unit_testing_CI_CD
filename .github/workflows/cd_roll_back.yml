name: Roll Back Cloudflare Worker on Failed Health Check

on:
  push:
    branches: [features/CD]

# minimal repo permissions; adjust if you need to write artifacts etc.
permissions:
  contents: read

env:
  # set defaults here; override via job env or repository secrets if needed
  WORKER_NAME: todo-worker
  RETRIES: 6
  RETRY_DELAY_SEC: 5
  HEALTH_URL: "https://todo-worker.vg-firmly.workers.dev/"

jobs:
  run-tests:
    name: Run tests
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          npm ci

      # - name: Run tests
      #   run: |
      #     npm test
      # this job will fail the workflow if tests fail

  deploy:
    name: Deploy with wrangler
    runs-on: ubuntu-latest
    needs: run-tests
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN_PROD }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy --name ${{ env.WORKER_NAME }}

  health-check:
    name: Health check
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      health_ok: ${{ steps.set_health.outputs.health_ok }}
    environment: production
    steps:
      - name: Check health endpoint
        id: health
        uses: jtalk/url-health-check-action@v3
        continue-on-error: true
        with:
          url: ${{ env.HEALTH_URL }}
          max-attempts: ${{ env.RETRIES }}
          retry-delay: ${{ env.RETRY_DELAY_SEC }}
          follow-redirect: true

      - name: Set health status
        id: set_health
        uses: actions/github-script@v7
        with:
          script: |
            const healthOk = '${{ steps.health.outcome }}' === 'success';
            core.setOutput('health_ok', healthOk.toString());

  rollback:
    name: Rollback to previous version (runs only when health-check reports failure)
    runs-on: ubuntu-latest
    needs: [health-check, deploy]
    if: needs.health-check.outputs.health_ok == 'false'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rollback Cloudflare Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN_PROD }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: rollback --name ${{ env.WORKER_NAME }}
