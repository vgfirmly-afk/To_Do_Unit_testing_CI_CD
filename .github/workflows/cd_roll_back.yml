name: Roll Back Cloudflare Worker on Failed Health Check

on:
  push:
    branches:
      - features/CD

env:
  WORKER_NAME: todo-worker
  RETRIES: 6
  RETRY_DELAY_SEC: 5
  HEALTH_URL: "https://todo-worker.vg-firmly.workers.dev/"

jobs:
  run-tests:
    name: Run tests
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install dependencies
        run: |
          npm ci

      # - name: Run tests
      #   run: |
      #     npm test
      # this job will fail the workflow if tests fail

  deploy:
    name: Deploy with wrangler
    runs-on: ubuntu-latest
    needs: run-tests
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN_PROD }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy --name ${{ env.WORKER_NAME }}

  health-check:
    name: Health check (non-failing; reports pass/fail)
    runs-on: ubuntu-latest
    needs: deploy
    outputs:
      health_ok: ${{ steps.set_out.outputs.health_ok }}
    environment: production
    steps:
      - name: Simple health probe with retries
        id: probe
        run: |
          set -e
          # If no health URL configured, mark as failed (you can change this policy)
          if [ -z "${{ env.HEALTH_URL }}" ]; then
            echo "No HEALTH_URL provided; marking health as failed."
            echo "health_ok=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          ok=false
          for i in $(seq 1 ${{ env.RETRIES }}); do
            echo "Health attempt $i..."
            # store body and http code
            http_code=$(curl -s -w "%{http_code}" -o /tmp/health_resp.txt "${{ env.HEALTH_URL }}" || true)
            body=$(cat /tmp/health_resp.txt || true)
            echo "status=$http_code"
            echo "body=$body"
            # Change condition to match your expected shape. Here we accept 200 and body contains "ok"
            if [ "$http_code" = "200" ] && echo "$body" | grep -qi "ok"; then
              ok=true
              break
            fi
            sleep ${{ env.RETRY_DELAY_SEC }}
          done

          if [ "$ok" = "true" ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Set job output
        id: set_out
        run: |
          if [ "${{ steps.probe.outputs.health_ok }}" = "true" ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

  rollback:
    name: Rollback to previous version (runs only when health-check reports failure)
    runs-on: ubuntu-latest
    needs: [health-check, deploy]
    if: needs.health-check.outputs.health_ok == 'false'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rollback Cloudflare Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN_PROD }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: rollback --name ${{ env.WORKER_NAME }}

  notify-slack:
    name: Send deployment status to Slack
    runs-on: ubuntu-latest
    needs: [health-check, rollback]
    if: always()
    environment: production
    steps:
      - name: Generate short SHA
        id: sha
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.health-check.outputs.health_ok }}" = "true" ]; then
            echo "deployment_status=healthy" >> $GITHUB_OUTPUT
            echo "message=âœ… New deployment is healthy and running successfully" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          elif [ "${{ needs.rollback.result }}" = "success" ]; then
            echo "deployment_status=rolled_back" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Deployment health check failed. Successfully rolled back to previous version" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          elif [ "${{ needs.rollback.result }}" = "skipped" ]; then
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            echo "message=âŒ Deployment health check failed but rollback was skipped" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            echo "message=âŒ Deployment health check failed and rollback was not executed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        run: |
          SHORT_SHA="${{ steps.sha.outputs.short_sha }}"
          STATUS_MSG="${{ steps.status.outputs.message }}"
          COLOR="${{ steps.status.outputs.color }}"
          WORKER_NAME="${{ env.WORKER_NAME }}"
          HEALTH_URL="${{ env.HEALTH_URL }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          PAYLOAD=$(jq -n \
            --arg text "Deployment Status: ${WORKER_NAME}" \
            --arg worker_name "${WORKER_NAME}" \
            --arg repo "${REPO}" \
            --arg branch "${BRANCH}" \
            --arg commit_url "${COMMIT_URL}" \
            --arg short_sha "${SHORT_SHA}" \
            --arg run_url "${RUN_URL}" \
            --arg status_msg "${STATUS_MSG}" \
            --arg actor "${ACTOR}" \
            --arg color "${COLOR}" \
            --arg health_url "${HEALTH_URL}" \
            '{
              text: $text,
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "ðŸš€ Deployment Status: \($worker_name)"
                  }
                },
                {
                  type: "section",
                  fields: [
                    {
                      type: "mrkdwn",
                      text: "*Repository:*\n\($repo)"
                    },
                    {
                      type: "mrkdwn",
                      text: "*Branch:*\n\($branch)"
                    },
                    {
                      type: "mrkdwn",
                      text: "*Commit:*\n<\($commit_url)|\($short_sha)>"
                    },
                    {
                      type: "mrkdwn",
                      text: "*Workflow:*\n<\($run_url)|View Run>"
                    }
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "*Status:*\n\($status_msg)"
                  }
                },
                {
                  type: "context",
                  elements: [
                    {
                      type: "mrkdwn",
                      text: "Deployed by: \($actor)"
                    }
                  ]
                }
              ],
              attachments: [
                {
                  color: $color,
                  fields: [
                    {
                      title: "Worker Name",
                      value: $worker_name,
                      short: true
                    },
                    {
                      title: "Health URL",
                      value: $health_url,
                      short: true
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "${PAYLOAD}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
