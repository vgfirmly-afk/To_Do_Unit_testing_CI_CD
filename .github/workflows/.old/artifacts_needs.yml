# name: CI â€” test + report

# on: [push, pull_request]

# jobs:
#   sample:
#     # runs-on: ubuntu-latest
#     runs-on: self-hosted
#     steps:
#       - name: Sample step
#         run: echo "This is a sample job."
#   test:
#     # runs-on: ubuntu-latest
#     runs-on: self-hosted
#     outputs:
#       coverage-folder: coverage

#     steps:
#       - uses: actions/checkout@v4

#       # --------------------------------
#       # Manual caching using path, key, restore-keys
#       # --------------------------------
#       - name: Restore npm cache
#         uses: actions/cache@v4
#         with:
#           path: ~/.npm
#           key: npm-${{ runner.os }}-node-24-${{ hashFiles('package-lock.json') }}
#           restore-keys: |
#             npm-${{ runner.os }}-node-24-
#             npm-${{ runner.os }}-

#       # --------------------------------
#       # Setup Node.js (cache disabled)
#       # --------------------------------
#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 24 # using Node 24 explicitly

#       - name: Install deps
#         run: npm ci

#       - name: Run tests (save log)
#         run: |
#           mkdir -p artifacts/logs
#           npm test 2>&1 | tee artifacts/logs/test.log

#       - name: Generate coverage
#         run: npm run coverage

#       - name: Upload coverage folder
#         uses: actions/upload-artifact@v4
#         with:
#           name: coverage-html
#           path: coverage
#           retention-days: 14

#       - name: Upload test log
#         uses: actions/upload-artifact@v4
#         with:
#           name: test-log
#           path: artifacts/logs/test.log
#           retention-days: 14

#   report:
#     needs: test
#     # runs-on: ubuntu-latest
#     runs-on: self-hosted

#     steps:
#       - name: Checkout (for context if needed)
#         uses: actions/checkout@v4

#       - name: Download coverage artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: coverage-html
#           path: artifacts/coverage

#       - name: Download test log
#         uses: actions/download-artifact@v4
#         with:
#           name: test-log
#           path: artifacts/logs

#       - name: List downloaded artifacts
#         run: |
#           echo "Coverage files:"
#           ls -la artifacts/coverage || true
#           echo "Test log preview:"
#           head -n 200 artifacts/logs/test.log || true

#       - name: Check coverage threshold (optional)
#         if: always()
#         run: |
#           if [ -f coverage/coverage-summary.json ]; then
#             cat coverage/coverage-summary.json
#           else
#             echo "No coverage summary found."
#           fi
